#!/usr/bin/python3
# -*- coding: utf-8 -*-

"""
Copyright Â© 2009-2015 The Caffeine Developers

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
"""


import argparse
import logging
import pkg_resources
import signal
import sys

from ewmh import EWMH as EWMH_CLASS
from gi.repository import GObject, Gtk, GLib
from subprocess import call
from Xlib.display import Display

__program__ = 'caffeine'
__description__ = 'Prevent desktop idleness in fullscreen mode.'
__version__ = pkg_resources.require('caffeine-reloaded')[0].version


class Caffeine(GObject.GObject):

    def __init__(self):
        GObject.GObject.__init__(self)

        self.activated = False
        self.root_id = hex(DISPLAY.screen().root.id)

        GObject.timeout_add(get_timeout(), self.execute)

    def execute(self):
        """Check for an active fullscreen window and respond appropriately."""

        fullscreen = is_fullscreen()

        # if inhibition state has changed, take action
        if self.activated != fullscreen:
            if fullscreen:
                self.inhibit()
            else:
                self.resume()

        return True

    def inhibit(self):
        """Inhibit the screensaver."""

        self.activated = True
        LOGGER.info('inhibiting desktop idleness')
        call(['caffeine-screensaver', 'suspend', self.root_id])

    def resume(self):
        """Resume the screensaver after being suspended."""

        if self.activated:
            self.activated = False
            LOGGER.info('no longer inhibiting desktop idleness')
            call(['caffeine-screensaver', 'resume', self.root_id])


def get_timeout():
    """Determine the program's timeout interval in milliseconds."""

    # seconds = DISPLAY.get_screen_saver().interval
    seconds = DISPLAY.get_screen_saver().timeout

    LOGGER.info('screen saver timeout = %d s', seconds)

    # default to 60s if screensaver is off otherwise use t minus 10s
    interval = (seconds - 10) * 1000 if seconds > 10 else 60000

    LOGGER.info('GObject interval = %d s', interval / 1000)

    return interval


# adapted from http://stackoverflow.com/questions/26388088/python-gtk-signal-handler-not-working
def init_signal(caffeine):
    def signal_action(sig):
        caffeine.resume()
        sys.exit(1)

    def idle_handler(*args):
        GLib.idle_add(signal_action, priority=GLib.PRIORITY_HIGH)

    def handler(*args):
        signal_action(args[0])

    def install_glib_handler(sig):
        # GLib.unix_signal_add was added in glib 2.36
        GLib.unix_signal_add(GLib.PRIORITY_HIGH, sig, handler, sig)

    # catch SIGINT/SIGTERM/SIGHUB and handle appropriately
    for sig in [signal.SIGINT, signal.SIGTERM, signal.SIGHUP]:
        signal.signal(sig, idle_handler)
        GLib.idle_add(install_glib_handler, sig, priority=GLib.PRIORITY_HIGH)


def is_fullscreen():
    """Check whether active window is fullscreen."""

    from Xlib.error import BadWindow

    window = EWMH.getActiveWindow()

    # getActiveWindow() will sometimes return None
    if window is None:
        return False

    try:
        return '_NET_WM_STATE_FULLSCREEN' in EWMH.getWmState(window, str=True)
    except BadWindow:
        return False


PARSER = argparse.ArgumentParser(
    add_help=False,
    description=__description__,
    prog=__program__,
    usage='%(prog)s [OPTION]...')
PARSER.add_argument(
    '--align',
    action='store_true',
    dest='align',
    help=argparse.SUPPRESS)
PARSER.add_argument(
    '-h', '--help',
    action='help',
    help=argparse.SUPPRESS)
PARSER.add_argument(
    '-q', '--quiet',
    action='store_true',
    dest='quiet',
    help='suppress normal output')
PARSER.add_argument(
    '-t', '--timestamp',
    action='store_true',
    dest='timestamp',
    help='timestamp log entries')
PARSER.add_argument(
    '-V', '--version',
    action='version',
    version=__program__ + ' ' + __version__)

OPTIONS = PARSER.parse_args()

# set up logging
SPACES = ' ' * (11 if OPTIONS.align else 1)
STR = '(%(name)s)' + SPACES + '%(levelname)s: %(message)s'

if OPTIONS.timestamp:
    FMT = ['%(asctime)s.%(msecs)03d ' + STR, '%Y-%m-%d %H:%M:%S']
else:
    FMT = [STR]

LOGGER = logging.getLogger(__program__)
STREAM = logging.StreamHandler()
FORMAT = logging.Formatter(*FMT)
STREAM.setFormatter(FORMAT)
LOGGER.addHandler(STREAM)

if not OPTIONS.quiet:
    LOGGER.setLevel(logging.INFO)

DISPLAY = Display()
EWMH = EWMH_CLASS()

# Calling GObject.threads_init() is not needed for PyGObject 3.10.2+
GObject.threads_init()
init_signal(Caffeine())
Gtk.main()
